# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy Node.js app to Azure Web App - homeview-backend

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest
        permissions:
            contents: read #This is required for actions/checkout

        steps:
            - uses: actions/checkout@v4

            - name: Set up Node.js version
              uses: actions/setup-node@v3
              with:
                  node-version: '22.x'

            # - name: npm install, generate prisma client, build, and test
            #   run: |
            #       npm install
            #       npx prisma generate
            #       npm run build --if-present
            #       npm run test --if-present

            - name: npm ci (faster than npm install)
              run: npm ci # --prefer-offline --no-audit

            - name: Generate Prisma Client
              env:
                  DATABASE_URL: ${{ secrets.DATABASE_URL }}
              run: npx prisma generate

            - name: Build node.js app
              env:
                  DATABASE_URL: ${{ secrets.DATABASE_URL }}
              run: npm run build

            - name: Deploy database migrations
              if: success()
              env:
                  DATABASE_URL: ${{ secrets.DATABASE_URL }}
              run: npx prisma migrate deploy

            - name: List artifact contents (debug)
              run: ls -R ./dist

            # - name: Upload artifact for deployment job
            #   uses: actions/upload-artifact@v4
            #   with:
            #       name: homeview-backend-artifact
            #       path: .

            - name: Prepare deployment package
              run: |
                  # Remove unnecessary files for deployment
                  rm -rf .git .github .vscode node_modules .next
                  # Keep only essential files for Azure deployment
                  mkdir -p deploy
                  cp -r build public src package.json package-lock.json deploy/
                  cp -r prisma deploy/ # Keep Prisma schema for runtime

            - name: Upload optimized artifact
              uses: actions/upload-artifact@v4
              with:
                  name: homeview-backend-artifact
                  path: deploy/
                  if-no-files-found: error

    deploy:
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Download artifact from build job
              uses: actions/download-artifact@v4
              with:
                  name: homeview-backend-artifact

            - name: 'Deploy to Azure Web App'
              id: deploy-to-webapp
              uses: azure/webapps-deploy@v3
              with:
                  app-name: 'homeview-backend'
                  slot-name: 'Production'
                  package: .
                  publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_9D12DCAA1C904790A86FFF448394C635 }}
